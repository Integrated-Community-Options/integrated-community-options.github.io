<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Locations with Zones</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <script>
        // Set up your Mapbox token
        mapboxgl.accessToken = 'pk.eyJ1Ijoib21hcmZpbmxleSIsImEiOiJjbTQ5MzBkbXMwNjlsMmpvbGtrNGpxYnF0In0.7zAj2YRadqPWPsQlavnfYA'; // Replace with your Mapbox token

        // Initialize the Mapbox map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11', // You can choose another Mapbox style
            center: [-118.2468, 34.0522], // Coordinates for the initial map view (center of LA)
            zoom: 10
        });

        // Add zoom and rotation controls to the map
        map.addControl(new mapboxgl.NavigationControl());

        // Zone data from KMeans clustering (Replace this with your actual zone data)
        const zoneData = [
            { lat: 34.07665376, lon: -117.84649169, zone: 0 },
            { lat: 29.67068, lon: -98.490543, zone: 1 },
            { lat: 36.0619, lon: -94.1613, zone: 2 },
            { lat: 39.2230395, lon: -121.0677435, zone: 3 },
            { lat: 34.15840488, lon: -118.30638538, zone: 4 },
            { lat: 33.268785, lon: -115.9521081, zone: 5 },
            { lat: 34.17027342, lon: -118.13992287, zone: 6 }
        ];

        // Create a GeoJSON for the zones
        const zonesGeoJSON = {
            type: 'FeatureCollection',
            features: zoneData.map((zone) => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [zone.lon, zone.lat] // Correct order: longitude first
                },
                properties: {
                    zone: zone.zone
                }
            }))
        };

        // Add zones as a layer on the map
        map.on('load', () => {
            map.addSource('zones', {
                type: 'geojson',
                data: zonesGeoJSON
            });

            map.addLayer({
                id: 'zones-layer',
                type: 'circle',
                source: 'zones',
                paint: {
                    'circle-radius': 10,
                    'circle-color': [
                        'match',
                        ['get', 'zone'],
                        0, '#ff0000',
                        1, '#00ff00',
                        2, '#0000ff',
                        3, '#ffff00',
                        4, '#ff00ff',
                        5, '#00ffff',
                        6, '#ff8000',
                        '#888888' // Default color for undefined zones
                    ],
                    'circle-opacity': 0.4
                }
            });

            // Get staff coordinates from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const staffCoordinatesParam = urlParams.get('staff_coordinates'); // Assume coordinates are passed as a string of lat, lon pairs

            if (staffCoordinatesParam) {
                // Parse the staff coordinates (assume they are separated by semicolons)
                const staffCoordinates = staffCoordinatesParam.split(';').map((coord, index) => {
                    const [lat, lon, name] = coord.split(',');
                    return { lat: parseFloat(lat), lon: parseFloat(lon), name: name.trim() };
                });

                // Create a GeoJSON for staff locations
                const staffGeoJSON = {
                    type: 'FeatureCollection',
                    features: staffCoordinates.map((staff) => ({
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [staff.lon, staff.lat] // Correct order: longitude first
                        },
                        properties: {
                            name: staff.name
                        }
                    }))
                };

                // Add staff locations as a layer on the map
                map.addSource('staff', {
                    type: 'geojson',
                    data: staffGeoJSON
                });

                map.addLayer({
                    id: 'staff-layer',
                    type: 'circle',
                    source: 'staff',
                    paint: {
                        'circle-radius': 6,
                        'circle-color': '#FF5733',
                        'circle-opacity': 0.8
                    }
                });

                // Add popups for staff markers with their names
                staffGeoJSON.features.forEach((staff) => {
                    const popup = new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`<strong>${staff.properties.name}</strong>`);

                    new mapboxgl.Marker()
                        .setLngLat([staff.lon, staff.lat]) // Correct order: longitude first
                        .setPopup(popup)
                        .addTo(map);
                });

            } else {
                console.log("No staff coordinates found in the URL.");
            }
        });
    </script>
</body>
</html>
